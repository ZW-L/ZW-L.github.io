(window.webpackJsonp=window.webpackJsonp||[]).push([[162],{575:function(t,s,a){"use strict";a.r(s);var n=a(25),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),a("ul",[a("li",[t._v("参考\n"),a("ul",[a("li",[a("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("阮一峰 Travis CI 教程"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/weixin_34029680/article/details/91459017",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用 Travis-ci 自动 SSH 部署 vue 代码"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.jianshu.com/p/f05ce2573b3c",target:"_blank",rel:"noopener noreferrer"}},[t._v("Travis CI 设置 Push 权限配置"),a("OutboundLink")],1)])])]),t._v(" "),a("li",[t._v("Travis 只能在 GitHub 上使用，而且访问速度较慢")]),t._v(" "),a("li",[t._v("优点是配置相对 jenkins 来说要简单，但是可配置性较低")])]),t._v(" "),a("h3",{attrs:{id:"用途"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用途"}},[t._v("#")]),t._v(" 用途")]),t._v(" "),a("ul",[a("li",[t._v("测试/构建并推送到分支：不需要自建服务器，适用于 github pages 或一些静态的项目；push 代码后，travis 会自动构建并 push 到指定的分支")]),t._v(" "),a("li",[t._v("测试/构建并部署到服务器：自动构建后推送到服务器")]),t._v(" "),a("li",[t._v("仅测试，然后执行服务器的构建和部署脚本，其余操作在服务器执行")])]),t._v(" "),a("h2",{attrs:{id:"构建并推送到分支"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#构建并推送到分支"}},[t._v("#")]),t._v(" 构建并推送到分支")]),t._v(" "),a("ol",[a("li",[t._v("使用 GitHub 授权登录 "),a("a",{attrs:{href:"https://travis-ci.org",target:"_blank",rel:"noopener noreferrer"}},[t._v("Travis"),a("OutboundLink")],1),t._v("，并勾选需要自动构建的仓库")]),t._v(" "),a("li",[t._v("本地安装 travis(需要使用 gem 命令，也就是要安装 Ruby)")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用国内 gem 源")]),t._v("\ngem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" gem "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" travis\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("一系列命令")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用 github 授权登录，需要输入账号密码，或者使用 token")]),t._v("\ntravis login --org\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd 到项目目录，然后生成密钥")]),t._v("\nssh-keygen -t rsa -b "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),t._v(" -C "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'build@travis-ci.org'")]),t._v(" -f ./deploy_rsa\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用 Travis 加密")]),t._v("\ntravis encrypt-file deploy_rsa --add\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 删除敏感文件，这些文件不需要 push 到远程仓库")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -f deploy_rsa deploy_rsa.pub\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将修改添加到 git 中，这两个文件必须提交到远程仓库")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" deploy_rsa.enc .travis.yml\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[t._v("配置 .travis.yml")])]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("language")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node_js\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用的 node 版本")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("node_js")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'12'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装依赖前的操作，主要是解密私钥")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 解密私钥，自动生成时 -out 后面的反斜杠需要删除")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" openssl aes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("256"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cbc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("K $encrypted_4e26a7ec6acd_key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("iv $encrypted_4e26a7ec6acd_iv\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("in deploy_rsa.enc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("out deploy_rsa "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 以下三个命令需要手动添加，用于使密钥生效(暂时看不懂)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' eval "$(ssh'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("agent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('s)"\n'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" chmod 600 deploy_rsa\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("add deploy_rsa\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装依赖")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行构建命令(取决与 package.json 的设置)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm run docs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("build\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 主要是初始化 git 仓库，并提交、推送到指定分支")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("after_success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" cd ./docs/.vuepress/dist\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git init\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git config "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('global user.name "Seven"\n'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git config "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('global user.email "1041214157@qq.com"\n'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git add .\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git commit "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('m "Automatically update from travis'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('ci"\n'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" git push "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('f "git@github.com'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("username/repo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('name.git" gh'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pages  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 覆盖至某分支")]),t._v("\n")])])]),a("h2",{attrs:{id:"构建并部署到服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#构建并部署到服务器"}},[t._v("#")]),t._v(" 构建并部署到服务器")]),t._v(" "),a("ul",[a("li",[t._v("操作与上述基本相同")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd 到项目目录，然后生成密钥")]),t._v("\nssh-keygen -t rsa -b "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),t._v(" -C "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'build@travis-ci.org'")]),t._v(" -f ./deploy_rsa\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 加密，因为解密时报错 `iv undefined`，因此这里加入了仓库名")]),t._v("\ntravis encrypt-file user/your-repo deploy_rsa --add\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 发送公钥到服务器")]),t._v("\nssh-copy-id -i deploy_rsa.pub "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("USER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("@"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("HOST"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 删除敏感文件，这些文件不需要 push 到远程仓库")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -f deploy_rsa deploy_rsa.pub\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将修改添加到 git 中，这两个文件必须提交到远程仓库")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" deploy_rsa.enc .travis.yml\n")])])]),a("ul",[a("li",[t._v("配置 .travis.yml")])]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("language")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node_js\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("node_js")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'12'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("addons")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ssh_known_hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" <Host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加说明，防止第一次登录询问是否建立连接")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("branch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" master\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" openssl aes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("256"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cbc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("K $encrypted_db2095f63ba3_key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("iv $encrypted_db2095f63ba3_iv\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("in deploy_rsa.enc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("out deploy_rsa "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' eval "$(ssh'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("agent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('s)"\n'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" chmod 600 deploy_rsa\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("add deploy_rsa\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm run build\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("after_success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" rsync "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("az "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("delete ./dist <User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("@<Host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/root/netease"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("music/web/dist  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 传输到服务器")]),t._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("备注")]),t._v(" "),a("ul",[a("li",[t._v("travis 使用 rsync 的传输速度很慢，构建时间可能超过10分钟，因此可以选择在服务端构建：")])]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("after_success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" .sh /root/netease"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("music/web/deploy.sh   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 脚本包含构建和部署的操作")]),t._v("\n")])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);